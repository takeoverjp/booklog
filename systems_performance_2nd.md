# Links

https://www.oreilly.co.jp/books/9784814400072/

# 1. イントロダクション

- 分析の視点には、アプリケーション開発者観点のワークロード分析と、システム管理者観点のリソース分析がある

- 観測手法には下記がある
  - カウンタ、統計量、指標
    - 例：procfs, vmstat
  - プロファイリング
    - 例：CPUプロファイリングとして、一定間隔ごとにon-CPUのコードパスをサンプリングする
  - トレーシング
    - 静的インストルメンテーション
      - 例
        - Linux kernelが予め用意したトレースポイント
        - USDT (user statically defined tracing)
        - execsnoop(8)を使うことで、どのようなコマンドのexecを実施したかを確認できる
          - topのようなサンプリングとは異なり、短時間で終了するプロセスの情報も収集できる
    - 動的インストルメンテーション
      - 例：kprobe, eBPF, perf, ftrace

- 60病で終わるLinuxパフォーマンス分析

```
# load average
$ uptime
 21:45:14 up 22:03,  2 users,  load average: 0.68, 0.44, 0.23
```

```
# OOMなどのkernel error
$ dmesg -T | tail
```

```
# 欄キュー、スワップ、CPU使用率などのシステムレベルの統計量
$ vmstat -SM 1
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 4  0      0  24069    136   5275    0    0    27    79  410    1  1  0 98  0  0
 2  0      0  24080    136   5278    0    0     0     0  654 1608  3  1 97  0  0
 1  0      0  24092    136   5274    0    0     0    28  392 1001  1  0 99  0  0
```

```
# CPU間のバランス。特定のCPUに負荷が偏っていないか
$ mpstat -P ALL 1
Linux 6.2.0-33-generic (biwa)   2023年10月05日  _x86_64_        (8 CPU)

21時49分16秒  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
21時49分17秒  all    2.26    0.00    1.13    0.00    0.00    0.00    0.00    0.00    0.00   96.61
21時49分17秒    0    1.02    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00   98.98
21時49分17秒    1    2.02    0.00    1.01    0.00    0.00    0.00    0.00    0.00    0.00   96.97
21時49分17秒    2    3.00    0.00    2.00    0.00    0.00    0.00    0.00    0.00    0.00   95.00
21時49分17秒    3    5.00    0.00    2.00    0.00    0.00    0.00    0.00    0.00    0.00   93.00
21時49分17秒    4    1.01    0.00    1.01    0.00    0.00    0.00    0.00    0.00    0.00   97.98
21時49分17秒    5    2.97    0.00    0.99    0.00    0.00    0.00    0.00    0.00    0.00   96.04
21時49分17秒    6    2.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00   98.00
21時49分17秒    7    1.00    0.00    2.00    0.00    0.00    0.00    0.00    0.00    0.00   97.00
```

```
# プロセスごとのCPU使用状況と、ユーザ/システムCPU時間の内訳
$ pidstat 1
Linux 6.2.0-33-generic (biwa)   2023年10月05日  _x86_64_        (8 CPU)

21時49分44秒   UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
21時49分45秒  1000      1026    0.96    0.00    0.00    0.00    0.96     3  gnome-shell
21時49分45秒  1000      1394    0.96    0.00    0.00    0.00    0.96     7  ibus-daemon
21時49分45秒  1000      1500    0.96    0.00    0.00    0.00    0.96     4  Xwayland
21時49分45秒  1000      1663    0.96    0.00    0.00    0.00    0.96     1  ibus-engine-moz
21時49分45秒  1000      1795    0.96    0.00    0.00    0.00    0.96     5  ibus-x11
21時49分45秒  1000      2176    0.96    0.96    0.00    0.00    1.92     7  code
21時49分45秒  1000      2211    1.92    0.96    0.00    0.00    2.88     2  code
21時49分45秒  1000      2243    4.81    0.00    0.00    0.00    4.81     5  code
21時49分45秒  1000      2894    0.96    0.96    0.00    0.00    1.92     2  code
21時49分45秒  1000      8706    0.00    0.96    0.00    0.00    0.96     4  chrome
21時49分45秒  1000     33476    0.96    0.96    0.00    0.00    1.92     4  pidstat
```

```
# ディスクIO統計：IOPS, スループット、平均待ち時間、ビジー状態の割合など
$ iostat -sxz 1
Linux 6.2.0-33-generic (biwa)   2023年10月05日  _x86_64_        (8 CPU)

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           1.16    0.01    0.38    0.16    0.00   98.30

Device             tps      kB/s    rqm/s   await  areq-sz  aqu-sz  %util
loop0             0.00      0.00     0.00    0.00     1.00    0.00   0.00
loop1             0.00      0.00     0.00    0.09     1.09    0.00   0.00
loop10            0.00      0.00     0.00    0.09     9.81    0.00   0.00
loop11            0.00      0.00     0.00    0.00     1.27    0.00   0.00
loop2             0.00      0.05     0.00    0.13    11.22    0.00   0.00
loop3             0.00      0.00     0.00    0.07     1.86    0.00   0.00
loop4             0.02      0.26     0.00    0.11    11.87    0.00   0.00
loop5             0.00      0.00     0.00    0.22     1.56    0.00   0.00
loop6             0.01      0.07     0.00    0.03     9.68    0.00   0.00
loop7             0.00      0.00     0.00    0.07     1.79    0.00   0.00
loop8             0.00      0.00     0.00    0.14     8.09    0.00   0.00
loop9             0.01      0.28     0.00    0.13    36.44    0.00   0.00
nvme0n1           5.67  11898.95     3.18    8.94  2097.69    0.06   1.25
sda               0.00      0.05     0.00    0.21    25.43    0.00   0.00


avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           2.27    0.00    0.50    0.00    0.00   97.23

Device             tps      kB/s    rqm/s   await  areq-sz  aqu-sz  %util


avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           1.00    0.00    0.50    0.12    0.00   98.38

Device             tps      kB/s    rqm/s   await  areq-sz  aqu-sz  %util
nvme0n1           2.00     24.00     4.00    1.50    12.00    0.00   0.40
```

```
# ファイルシステムキャッシュを含むメモリ使用状況
$ free -m
               total        used        free      shared  buff/cache   available
Mem:           31956        4283       23989        1339        5493       27672
Swap:           8191           0        8191
```

```
# ネットワークデバイスI/O。パケットとスループット
$ sar -n DEV 1
Linux 6.2.0-33-generic (biwa)   2023年10月05日  _x86_64_        (8 CPU)

21時52分27秒     IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s   txcmp/s  rxmcst/s   %ifutil
21時52分28秒        lo      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
21時52分28秒      eno1      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
21時52分28秒 wlp0s20f3      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00

21時52分28秒     IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s   txcmp/s  rxmcst/s   %ifutil
21時52分29秒        lo      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
21時52分29秒      eno1      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
21時52分29秒 wlp0s20f3      5.00      4.00      0.51      2.71      0.00      0.00      0.00      0.00
```

```
# TCP統計。接続のスピード、再送
$ sar -n TCP,ETCP 1
Linux 6.2.0-33-generic (biwa)   2023年10月05日  _x86_64_        (8 CPU)

21時52分45秒  active/s passive/s    iseg/s    oseg/s
21時52分46秒      0.00      0.00      0.00      0.00

21時52分45秒  atmptf/s  estres/s retrans/s isegerr/s   orsts/s
21時52分46秒      0.00      0.00      0.00      0.00      0.00

21時52分46秒  active/s passive/s    iseg/s    oseg/s
21時52分47秒      1.00      0.00      0.00      1.00

21時52分46秒  atmptf/s  estres/s retrans/s isegerr/s   orsts/s
21時52分47秒      0.00      0.00      0.00      0.00      0.00
```

```
# 全体的なチェック
$ top
```

- `offcputime`(8)を使えば、off-CPUで過ごした時間の情報を取り出すことができる。
  - off-CPUとは、IOやlock, timer, paging/swapping街などにより、CPUを使わずに消費している時間のこと
  - 参考：https://www.brendangregg.com/offcpuanalysis.html
