# Binary Hacks Rebooted

## Links

- [Binary Hacks Rebooted](https://www.oreilly.co.jp/books/9784814400850/)

## 1. イントロダクション

### #1 未知のバイナリの読み方

- `file`, `hexdump -C`
  - `hexdump`で見ることで、制御文字も確認できる。マッチするはずの正規表現がマッチしない時は見てみると良いかも？
- `__attribute__((packed))`を付与することで、構造体をパディングせずに配置することを指示できる。デバイスドライバ等でC言語のアラインメントのルールに従えない場合に利用する。
- ELFでは4KiBでアラインメントをしている。これはページサイズに合わせることで、複数プロセス間のコードページ等の共有を用意にするため。

### #2 アセンブリ入門

- `objdump --disassembile=XXX`とすることで、`XXX`関数のみをディスアセンブルすることができる


### #3 Hello, World! 再訪

- 以下のようなメモリ上の領域を確保して、何らかの命令を実行する場合、そのバイト列は小さくてPICであることが必要
  - 領域に任意のバイト列を書き込むことができる
  - プログラムカウンタが指す先を領域の先頭に設定できる
  - 領域がどのアドレス範囲になるかは事前にわからない
  - 領域は比較的小さい

- 命令列を置くセクションと、文字列を置くセクションを同じにすることで、サイズを小さくする
- 文字列のアドレスをレジスタに入れる際に`call`命令を使うことで、PICを保ちながら`rsi`レジスタに代入することができる

## 2. ELF Hack

### #4 ELFファイルのセグメント

- ELFファイルには、３種類のヘッダがある
  - ELFヘッダ：残り２つのヘッダのオフセットや、OS/CPU architectureの情報
  - セクションヘッダ：リンカやデバッガ用。実行には必須ではない。
  - プログラムヘッダ：ダイナミックリンカやカーネル用。実行に必須。各セグメントについて対応するプログラムヘッダがある。

- `PT_NOTE`は`readelf --note hello`で確認でき、ビルドIDやOSの情報など、補助的な情報が入っている
- `PT_TLS`には、Thread Local Storage (TLS)の初期値が入っている
- `PT_GNU_RELRO`のセグメントは、ロードしたメモリの対応する範囲をリロケーションが終わったあとに読み込み専用にする。GOT Overwrite攻撃対策。RELROが普及するにつれて、lazy bindingは使われなくなりつつある。

### #5 ld-linux.soの環境変数を利用する

- 詳細は`man ld-linux.so`
- `LD_DEBUG=symbols`でシンボル解決の様子を確認できる
- `LD_AUDIT`環境変数で、ld-linux.soが新たにシンボルを束縛したときやPLTエントリ内の関数が呼び出されたときにユーザが登録したコールバックを呼び出すことができる

### #6 共有ライブラリを検索するディレクトリ

- `man ld-linux.so`
- `PT_DYNAMIC`セグメントの`DT_RPATH`フィールドは最も優先度が高いが、今は推奨されていない
- `LD_LIBRARY_PATH`環境変数が実質最も優先度が高いが、セキュリティ実行モードでは無視される
- `PT_DYNAMIC`セグメントの`DT_RUNPATH`フィールドを使うことで、実行バイナリと共有ライブラリをセットで配布する時に、自身の共有ライブラリを指定するためなどに利用する

- セキュリティ実行モード
  - 起動時の補助ベクトルに`AT_SECURE`タグを持つエントリが含まれる場合に、ダイナミックリンカはセキュリティ実行モードで動作する
  - setuidにより実行ユーザIDと実ユーザIDが異なる場合などに有効になる
    - `LD_LIBRARY_PATH`により任意のコードを実行できる状況を避けなければならない

### #7 dlopenによるライブラリの実行時ロードとその応用テクニック

- dlopen/dlsymの用途
  - ビルド時には存在しないライブラリを実行時にリンク／ロードする
  - プラグイン機構を提供する
  - `LD_PRELOAD`と組み合わせて、既存のライブラリ関数をラップする
  - `libc_start_main`関数をラップすることで、main関数の前に任意の処理（サンドボックスの初期化など）を差し込む

## 3. OS Hack

- 

## 4. コンテナHack

- 

## 5. デバッガ・トレーサHack

- 

## 6. セキュリティHack

- 

## 7. 数値表現とデータ処理Hack

- 

## 8. 言語処理系Hack

- 

## 9. そのほかのHack

- 
