# Links

https://www.oreilly.co.jp/books/9784814400423/

# 1. 攻撃者はいかにしてシステムを攻撃するのか

- ゼロデイ攻撃とは、修正方法がまだ知られていない脆弱性に対する攻撃のこと
- 標的型攻撃とは、特定の組織を狙った攻撃のこと
- ロシアによるウクライナ侵攻においては、現実の軍事行動とサイバー攻撃が並行して行われていた
  - PCの無力化・Webサイトの改ざん・プロバイダへの攻撃によるインターネット普通など
- 攻撃手法のモデルはいくつかあるが、この本ではUnified Kill Chainという18段階のプロセスを紹介している
- 偵察の手段としては、Shodan, Censysなどで公開されている情報による受動的偵察と、ポートスキャンやGoogle Hackingなどによる能動的偵察がある
- 自給自足攻撃：標的の端末にインストールされているソフトウェアを使った攻撃
  - Linuxにおける自給自足方法：[GTFOBins](https://gtfobins.github.io/)

- Subdomain Takeover
  - 有効なドメインに対応するホストが公開されていない場合、攻撃者に乗っ取られるリスクがある

- TOTP (Time-Based One Time Password) に対応したフィッシングサイトもある
- システムへの持続的なアクセス獲得のことを、永続化という
  - アカウントの変更や、自動起動プログラムの変更など
  - このあたりは被害を最小にするために特に気を付ける必要がある

- C2 (Command and Control) サーバとの通信は、正常な通信に紛れ込ませるため下記の手法などが取られる
  - ドメインフロンティング：TLSのSNIヘッダとHTTPのHostヘッダをずらすことで、CDNへの通信に紛れ込ませる
  - DNSトンネリング
    - C2サーバがDNSサーバを装い、DNSプロトコル上で情報をやり取りする
    - DNS通信ログを残すことが少ない、DNSプロトコル上は正常、C2と直接接続しないため、検出・追跡が難しい

- ピボッティングとは、踏み台アクセスのこと。開発環境としてはよく使うが、商品ではしっかり蓋じめが必要。
- 持ち出しにおいて、IDS/IPSに検知されないよう、正常系のアップロードに紛れ込ませる
  - アップロード先・タイミングなど

# 2. Scapyでポートスキャナを自作し動作原理を知ろう

- [Docker composeを使った環境構築](https://github.com/oreilly-japan/pentest-starting-with-port-scanner/blob/main/containers/README.md)
  - ペンテスター用のホストと攻撃対象のホストが同一Dockerネットワークにいるコンテナ群
  - Docker内とは言えmetasploit-frameworkをインストールしたりするので、ネットワークによっては遮断されているかも
  - 22番ポートや80番ポートを使うので、ホスト環境とポート番号かぶる可能性高し

- Scapy入門
  - パケット処理pythonライブラリ
  - 下記はICMPパケットを送ったときログ
  - `sr1`はネットワーク層でパケットを送信したのち１つの応答パケットを返す

```
>>> from scapy.all import *
>>> req = IP(dst="10.8.9.3")/ICMP()
>>> res = sr1(req, timeout=3)
Begin emission:
Finished sending 1 packets.
.*
Received 2 packets, got 1 answers, remaining 0 packets
>>> res.show()
###[ IP ]### 
  version   = 4
  ihl       = 5
  tos       = 0x0
  len       = 28
  id        = 28191
  flags     = 
  frag      = 0
  ttl       = 64
  proto     = icmp
  chksum    = 0xe6a8
  src       = 10.8.9.3
  dst       = 10.8.9.7
  \options   \
###[ ICMP ]### 
     type      = echo-reply
     code      = 0
     chksum    = 0x0
     id        = 0x0
     seq       = 0x0
     unused    = ''
```

- Scapyでパケットキャプチャも可能(`sniff`)
- Scapyの使い方を知りたいときは、`ls()`, `ls(ICMP)`, `help(ICMP)`, `lsc()`など

- ポートスキャンには、以下の２種類がある
  - TCP SYNスキャン: SYNを送ってSYN/ACKが返ってくるかどうか
  - TCP Connectスキャン: SYNを送ってSYN/ACKが返ってきた場合、ACKまで返して接続まで行う
 
- アプリ層でSYNを投げた場合、SYN/ACK受信時にiptablesが不正なパケットを受信したとしてRSTを返してしまう
　　- Scapyを使ったTCP Connectスキャンを動かす時は、一時的にiptablesを無効化する必要がある

# 3. デファクトスタンダードのポートスキャナNmap

- UDPもスキャンできる。そのときはなんらかの応答パケットがあればポートが開いていると判断する
- nmapはホストごとに並列でスキャンする

- 高速にポートスキャンをした結果、通信がブロックされ、ポートが閉じていると誤判定してしまうことがある
- SYNスキャンはブロックされて、TCP Connectスキャンならブロックされない場合もある

- nmapより高速なポートスキャンツールとして、MASSCANやRustScanがある
- ただし、ペンテスターとしてはクライアントの業務を阻害しない範囲で検査を行うことも大事なので、いつでも高速な方が良いとは限らない

- nmapでは、luaスクリプトを実行することができる
- `nmap -p 22 --script ssh-brute localhost`とすることで、localhostにたいしてブルートフォース攻撃を行い、root/passwordといったパスワードでログインできないか確認することができる
- 下記は有名脆弱性のスキャンをexample.comに対して実施した例。いくつか実行がエラーになっているが、問題は見つかっていない。

```
pentester@a84c98d1da16:~$ nmap --script vuln example.com
Starting Nmap 7.80 ( https://nmap.org ) at 2023-09-26 23:01 JST
Nmap scan report for example.com (93.184.216.34)
Host is up (0.14s latency).
Other addresses for example.com (not scanned): 2606:2800:220:1:248:1893:25c8:1946
Not shown: 996 filtered ports
PORT     STATE  SERVICE
80/tcp   open   http
|_clamav-exec: ERROR: Script execution failed (use -d to debug)
|_http-csrf: Couldn't find any CSRF vulnerabilities.
|_http-dombased-xss: Couldn't find any DOM based XSS.
|_http-stored-xss: Couldn't find any stored XSS vulnerabilities.
|_http-vuln-cve2014-3704: ERROR: Script execution failed (use -d to debug)
443/tcp  open   https
|_clamav-exec: ERROR: Script execution failed (use -d to debug)
|_http-csrf: Couldn't find any CSRF vulnerabilities.
|_http-dombased-xss: Couldn't find any DOM based XSS.
|_http-stored-xss: Couldn't find any stored XSS vulnerabilities.
|_sslv2-drown: 
1119/tcp closed bnetgame
1935/tcp closed rtmp

Nmap done: 1 IP address (1 host up) scanned in 86.55 seconds
```

# 4. 既知脆弱性を発見できるネットワークスキャナNessus

- Nessus Essentialsを使えば、無償で商用レベルの脆弱性スキャンを試すことができる
- とはいえ、既知の脆弱性を見つけることができるだけで、全てをみつけられるわけではないことは留意する必要がある

# 5. 攻撃コードを簡単に生成できるMetasploit Framework

- Metasploit Frameworkに含まれる、msfconsoleを使えば、対話的に攻撃を行うことができる。
- Meterpreterを使えば、メモリインジェクションを行い、新しいプロセスを生成せずに、侵害したプロセスに自身を注入できる。
  - ストレージにデータを書くこともないので、痕跡が残りにくい
- フォレンジックとは、情報漏えいや不正行為が発生した場合に、ディスクやメモリのダンプファイル、ログファイルなどから攻撃の探索をする技術。
- リバースシェル
  - プライベートネットワークに存在する攻撃対象の端末から、パブリックIPが付与された攻撃者の端末に接続させることで得られる、攻撃者の端末から標的の上で任意のコマンドを実行できる環境のこと。
  - 正確には攻撃に限らず使える技術で、VPNを介して開発機を制御する場合などにも活用することができる。
  - 通常は制御する端末から制御される端末に接続するのに対し、接続の向きが逆向きなのでリバースシェルと呼ばれる
- metasploitにはテンプレート的な攻撃が含まれているので、効率よく様々な攻撃手法を試すことができる

# 6. 攻撃者はどのように被害を拡大するか

- ファイル読み込みを成功させた後の攻撃は、読めたファイルによって変わる
  - 仮に/etc/shadowが読めた場合、パスワードが推定できる可能性がある
- ファイル書き込みを成功させた後
  - webシェルの配置
  - ssh公開鍵の配置
  - cronを用いた永続化て権限昇格
