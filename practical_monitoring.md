# links

https://www.oreilly.co.jp/books/9784873118642/

# 1. 監視のアンチパターン

- アンチパターンとは、一見良いアイディアだが実装すると手痛いしっぺ返しを食らうものをいう。

## アンチパターン１：ツール依存

- ミッションを遂行するために何が必要か、という観点で考え、要求に見合うツールを探さなければならない
- 観察者効果は気にしない
- ツールを採用する前に、試してみることが大事。知名度の高い会社が使っているというだけで採用してはいけない

## アンチパターン２：役割としての監視

- 監視は中身を知らずにできるものではないので、特定のメンバーだけに責任を負わせるべきではなく、開発メンバー全員で取り組むべき
- 監視ツールを内製するときに、その開発責任を特定のメンバーに負わせることは正しい

## アンチパターン３：チェックボックス監視

- 「監視してます」と言うための監視は、むしろないよりひどい
- システムが「動いている」状態をきちんと定義し、その条件を満たせていないときにアラートするべき
- 例えば、レスポンスタイムが許容範囲に収まっていなければ問題だが、レスポンスタイムが許容範囲に収まっているのであればCPU使用率が99%で張り付いている事自体は問題ではない
- 正しく兆候を捉えるためには、最低でも60秒に１回メトリクスを取得する

## アンチパターン４：監視を支えにする

- 監視すべき項目を追加し続けている場合、サービス自体を安定して回復力のあるものにするべき

## アンチパターン５：手動設定

- 各サービスは、誰かが設定を追加するのではなく、勝手に登録されるようにすべき

# 2. 監視のデザインパターン
## デザインパターン1：組み合わせ可能な監視

- Unix哲学
- 監視の要素
  - データ収集
    - メトリクス
    - ログ
      - 構造化ログ
      - 非構造化ログ
  - データストレージ
  - 可視化
    - 円グラフは使わない
  - 分析とレポート
  - アラート
    - 可用性は依存先サービス以上にはできない
    - AWS EC2ですら99.95%
 
- SLAはほとんど願望や嘘

## デザインパターン2：ユーザ視点での監視

## デザインパターン3:作るのではなく買う

安いし、専門でないし、その方が良いから
明確に足りない機能がわかっている時だけ内製を検討する

## デザインパターン4：継続的改善

Googleなども、何年もかけて改善してきた結果、今の仕組みを作り上げている

# 3. アラート、オンコール、インシデント管理

- ここでアラートとは、アラートを受け取った人に緊急性があり、すぐに対応する必要があることを認識させるためのもの
- よいアラートの仕組みを作る方法
  - アラートにメールは使わない
  - アラート発生後に実施するべきことの手順書を書く
  - アラートの条件は、固定のしきい値である必要はない
  - アラートを棚卸しする
    - どんなアラートが発生したかの記録を作る
  - サービスの作業を実施するときは、アラートのメンテナンス期間機能を利用する
  - アラート発生後の作業が定型的なものであれば、まずは自動復旧できないか検討する
  - インシデント解決後、振り返る

# ４．統計入門

- 統計値
  - 平均：広く使える。移動平均で平滑化できる。
  - 中央値：一方向に大きな偏りがある場合に、平均より特徴を捉えることができる
  - 周期性：時系列データの規則を表現することができる
  - 標準偏差：監視用途では使えないことが多い
- データセット
  - どちらかに偏りがあるか？
  - 極端な外れ値はよく発生するか
  - 上限・下限はあるか？

# 5. ビジネスを監視する

- ユーザ個別の分析ではなく、サイトに対するトラフィックレベルのヒントにメトリクスを活用する
- 自分のアプリケーションにメトリクスがない場合は追加する
- ビジネスKPIはプロダクトマネージャーと話すことで明確化できる
- 機能の概略図を書くことで、監視すべきポイントを見つける
